<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>DnD 5e Scheda PG Completa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f4e8c1; --bg-alt: #d9b38c; --accent: #8b4513; --accent-soft: #cd853f;
      --text: #2c1810; --muted: #654321; --border: #a0522d; --danger: #b22222;
      --success: #228b22; font-family: 'Georgia', serif; font-size: 14px;
    }
    @media (max-width: 768px) { :root { font-size: 12px; } }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); padding: 1rem; max-width: 1400px; margin: auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; background: var(--bg-alt); padding: 1rem; border-radius: 8px; }
    .badge { padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; }
    .sync-ok { background: var(--success); color: white; }
    .sync-err { background: var(--danger); color: white; }
    .search { flex: 1; margin: 0 1rem; }
    input[type="search"] { width: 100%; padding: 0.5rem; border: 2px solid var(--border); border-radius: 4px; }
    .btn { padding: 0.5rem 1rem; margin: 0 0.25rem; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .char-list { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .char-item { background: var(--bg-alt); padding: 1rem; border-radius: 8px; cursor: pointer; min-width: 200px; flex: 1; }
    .char-item:hover { background: var(--accent-soft); }
    .char-item.active { border: 3px solid var(--accent); }
    nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    nav .btn { flex: 1; }
    .section { display: none; background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .section.active { display: block; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    label { font-weight: bold; display: block; margin-bottom: 0.25rem; }
    input, textarea, select { width: 100%; padding: 0.5rem; border: 2px solid var(--border); border-radius: 4px; font-size: inherit; }
    textarea { height: 4rem; resize: vertical; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .stat { text-align: center; background: var(--bg-alt); padding: 1rem; border-radius: 8px; }
    .stat-score { font-size: 2rem; font-weight: bold; }
    .attacks-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
    .attack { background: var(--bg-alt); padding: 1rem; border-radius: 8px; }
    .tag-filter { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .tag-btn { background: var(--muted); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
    .tag-btn.active { background: var(--accent); }
    .tagged-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    .tagged-item { background: var(--bg-alt); padding: 1rem; border-radius: 8px; }
    .print-view { background: white; max-width: 850px; margin: auto; padding: 2rem; font-size: 10px; }
    .print-view .grid { grid-template-columns: repeat(6, 1fr); }
    @media print { body { padding: 0; } .print-view { box-shadow: none; } }
    .dirty { border-color: var(--danger); }
    @media (max-width: 768px) { .grid, .stats-grid { grid-template-columns: 1fr; } nav { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>D&D 5e Scheda PG</h1>
    <div class="badge sync-ok" id="syncBadge">Sync: caricamento...</div>
  </div>
  <input type="search" id="searchInput" placeholder="Cerca PG per nome/classe...">
  <div class="char-list" id="charList"></div>
  <button class="btn btn-primary" onclick="newChar()">âœš Nuovo PG</button>
  <nav>
    <button class="btn btn-primary active" onclick="showSection('edit')">Modifica</button>
    <button class="btn btn-primary" onclick="showSection('tags')">Tag/Filtri</button>
    <button class="btn btn-primary" onclick="showPrintView()">Scheda Ufficiale</button>
  </nav>
  
  <!-- Sezione Modifica -->
  <div id="edit" class="section active">
    <div class="grid">
      <div>
        <label>Nome PG</label><input id="name">
        <label>Classe/Livello</label><input id="classLevel">
        <label>Razza/Background</label><input id="raceBg">
        <label>HP Max/Current</label><input id="hp">
        <label>AC</label><input id="ac">
        <label>Iniziativa</label><input id="initiative">
        <label>VelocitÃ </label><input id="speed">
      </div>
      <div class="stats-grid">
        <div class="stat"><label>Forza</label><div class="stat-score" id="strScore">10</div><div id="strMod">+0</div></div>
        <div class="stat"><label>Destrezza</label><div class="stat-score" id="dexScore">10</div><div id="dexMod">+0</div></div>
        <div class="stat"><label>Costituzione</label><div class="stat-score" id="conScore">10</div><div id="conMod">+0</div></div>
        <div class="stat"><label>Intelligenza</label><div class="stat-score" id="intScore">10</div><div id="intMod">+0</div></div>
        <div class="stat"><label>Saggezza</label><div class="stat-score" id="wisScore">10</div><div id="wisMod">+0</div></div>
        <div class="stat"><label>Carisma</label><div class="stat-score" id="chaScore">10</div><div id="chaMod">+0</div></div>
      </div>
      <div>
        <label>Competenze/Lingue</label><textarea id="proficiencies"></textarea>
        <label>AbilitÃ  (salvataggi/skills)</label><textarea id="skills"></textarea>
      </div>
    </div>
    <div class="attacks-grid" id="attacks">
      <div class="attack">
        <label>Nome Attacco</label><input class="attackName">
        <label>Bonus Attacco</label><input class="attackBonus">
        <label>Danno/Tipo</label><input class="attackDamage">
        <label>Tag</label><input class="attackTag" placeholder="azione,bonus,reazione,rituale,altro">
        <button class="btn btn-danger" onclick="removeAttack(this)"> Rimuovi </button>
      </div>
    </div>
    <button class="btn btn-primary" onclick="addAttack()">+ Aggiungi Attacco</button>
    <div class="grid">
      <div>
        <label>Equipaggiamento</label><textarea id="equipment"></textarea>
      </div>
      <div>
        <label>Incantesimi (lista)</label><textarea id="spells"></textarea>
        <label>Tratti/Features</label><textarea id="features"></textarea>
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveCurrent()">ðŸ’¾ Salva</button>
    <button class="btn btn-danger" id="deleteBtn" onclick="deleteCurrent()" disabled>ðŸ—‘ Elimina</button>
  </div>

  <!-- Sezione Tag/Filtri -->
  <div id="tags" class="section">
    <div class="tag-filter">
      <div class="tag-btn active" data-tag="all">Tutti</div>
      <div class="tag-btn" data-tag="azione">Azioni</div>
      <div class="tag-btn" data-tag="bonus">Bonus</div>
      <div class="tag-btn" data-tag="reazione">Reazioni</div>
      <div class="tag-btn" data-tag="rituale">Rituali</div>
      <div class="tag-btn" data-tag="altro">Altro</div>
    </div>
    <div class="tagged-items" id="taggedItems"></div>
  </div>

  <!-- Vista Stampa Scheda Ufficiale -->
  <div id="printView" class="section print-view" style="display:none;">
    <h2 id="printName"></h2>
    <!-- Layout fedele PDF: stats in alto, skills sotto, attacchi, features etc. [web:29] -->
    <div class="grid">
      <div id="printClassLevel"></div><div id="printRaceBg"></div><div id="printHpAc"></div>
    </div>
    <!-- Stats row -->
    <div class="stats-grid" style="grid-template-columns: repeat(6,1fr);">
      <div id="printStr"></div><div id="printDex"></div><div id="printCon"></div>
      <div id="printInt"></div><div id="printWis"></div><div id="printCha"></div>
    </div>
    <div class="grid">
      <div id="printSkills"></div><div id="printAttacksPrint"></div><div id="printFeatures"></div>
    </div>
    <button class="btn" onclick="window.print()">Stampa PDF</button>
  </div>

  <script>
    const STORAGE_KEY = "dnd_chars_v2";
    // Sostituisci con la tua URL Apps Script [conversation_history:13]
    const API_URL = "https://script.google.com/macros/s/AKfycbzXkdt6igLPF-etHankoJ6AYPEYDv0UJNW4Um2xJlFVmrplYlhfSILsIZom7KDtGTyv/exec";
    let characters = [], currentId = null, dirty = false;

    // Calc mod
    function mod(score) { return Math.floor((score - 10) / 2); }

    // Load stat inputs change listeners
    function updateMods() {
      ['str','dex','con','int','wis','cha'].forEach(stat => {
        const score = parseInt(document.getElementById(stat + 'Score').value) || 10;
        document.getElementById(stat + 'Mod').textContent = '+' + (mod(score) >= 0 ? mod(score) : mod(score));
        document.getElementById(stat + 'Score').nextSibling.textContent = score;
      });
    }
    ['str','dex','con','int','wis','cha'].forEach(stat => {
      document.getElementById(stat + 'Score').addEventListener('input', updateMods);
    });

    function newChar() {
      currentId = null;
      document.querySelectorAll('input,textarea').forEach(el => el.value = '');
      ['str','dex','con','int','wis','cha'].forEach(stat => document.getElementById(stat + 'Score').value = 10);
      updateMods();
      document.getElementById('name').focus();
      setDirty(false);
      document.getElementById('deleteBtn').disabled = true;
      renderCharList('');
    }

    function saveCurrent() {
      const char = {
        id: currentId || Date.now().toString(),
        name: document.getElementById('name').value,
        classLevel: document.getElementById('classLevel').value,
        raceBg: document.getElementById('raceBg').value,
        hp: document.getElementById('hp').value,
        ac: document.getElementById('ac').value,
        initiative: document.getElementById('initiative').value,
        speed: document.getElementById('speed').value,
        strScore: parseInt(document.getElementById('strScore').value),
        dexScore: parseInt(document.getElementById('dexScore').value),
        conScore: parseInt(document.getElementById('conScore').value),
        intScore: parseInt(document.getElementById('intScore').value),
        wisScore: parseInt(document.getElementById('wisScore').value),
        chaScore: parseInt(document.getElementById('chaScore').value),
        proficiencies: document.getElementById('proficiencies').value,
        skills: document.getElementById('skills').value,
        equipment: document.getElementById('equipment').value,
        spells: document.getElementById('spells').value,
        features: document.getElementById('features').value,
        attacks: Array.from(document.querySelectorAll('.attack')).map(row => ({
          name: row.querySelector('.attackName').value,
          bonus: row.querySelector('.attackBonus').value,
          damage: row.querySelector('.attackDamage').value,
          tag: row.querySelector('.attackTag').value
        })).filter(a => a.name)
      };
      const idx = characters.findIndex(c => c.id === char.id);
      if (idx > -1) characters[idx] = char; else characters.push(char);
      currentId = char.id;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(characters));
      setDirty(false);
      document.querySelectorAll('input,textarea').forEach(el => el.classList.remove('dirty'));
      syncToServer();
      renderCharList(document.getElementById('searchInput').value);
      document.getElementById('deleteBtn').disabled = false;
    }

    function deleteCurrent() {
      if (currentId && confirm('Elimina PG?')) {
        characters = characters.filter(c => c.id !== currentId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(characters));
        syncToServer();
        newChar();
      }
    }

    function loadChar(char) {
      document.getElementById('name').value = char.name || '';
      document.getElementById('classLevel').value = char.classLevel || '';
      document.getElementById('raceBg').value = char.raceBg || '';
      document.getElementById('hp').value = char.hp || '';
      document.getElementById('ac').value = char.ac || '';
      document.getElementById('initiative').value = char.initiative || '';
      document.getElementById('speed').value = char.speed || '';
      document.getElementById('strScore').value = char.strScore || 10;
      document.getElementById('dexScore').value = char.dexScore || 10;
      document.getElementById('conScore').value = char.conScore || 10;
      document.getElementById('intScore').value = char.intScore || 10;
      document.getElementById('wisScore').value = char.wisScore || 10;
      document.getElementById('chaScore').value = char.chaScore || 10;
      updateMods();
      document.getElementById('proficiencies').value = char.proficiencies || '';
      document.getElementById('skills').value = char.skills || '';
      document.getElementById('equipment').value = char.equipment || '';
      document.getElementById('spells').value = char.spells || '';
      document.getElementById('features').value = char.features || '';
      currentId = char.id;
      renderAttacks(char.attacks || []);
      setDirty(false);
      document.getElementById('deleteBtn').disabled = false;
    }

    function addAttack() {
      const div = document.createElement('div');
      div.className = 'attack';
      div.innerHTML = `
        <label>Nome</label><input class="attackName">
        <label>Bonus</label><input class="attackBonus">
        <label>Danno</label><input class="attackDamage">
        <label>Tag</label><input class="attackTag" placeholder="azione,bonus,reazione,rituale,altro">
        <button class="btn btn-danger" onclick="removeAttack(this)">Rimuovi</button>
      `;
      document.getElementById('attacks').appendChild(div);
    }

    function removeAttack(btn) {
      btn.closest('.attack').remove();
    }

    function renderAttacks(attacks) {
      document.getElementById('attacks').innerHTML = attacks.map(a => `
        <div class="attack">
          <label>Nome</label><input class="attackName" value="${a.name}">
          <label>Bonus</label><input class="attackBonus" value="${a.bonus}">
          <label>Danno</label><input class="attackDamage" value="${a.damage}">
          <label>Tag</label><input class="attackTag" value="${a.tag}">
          <button class="btn btn-danger" onclick="removeAttack(this)">Rimuovi</button>
        </div>
      `).join('') || '<div class="attack"><em>Aggiungi il primo attacco</em></div>';
    }

    function renderCharList(filter) {
      const list = document.getElementById('charList');
      const filtered = characters.filter(c => 
        c.name.toLowerCase().includes(filter.toLowerCase()) || 
        c.classLevel.toLowerCase().includes(filter.toLowerCase())
      );
      list.innerHTML = filtered.map(c => 
        `<div class="char-item ${c.id === currentId ? 'active' : ''}" onclick="loadChar(${JSON.stringify(c)})">
          <strong>${c.name}</strong><br>${c.classLevel} ${c.raceBg}<br>HP: ${c.hp}
        </div>`
      ).join('');
    }

    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('nav .btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      if (id === 'tags') renderTags();
      if (id === 'print') showPrintView();
    }

    function renderTags() {
      const items = characters.find(c => c.id === currentId)?.attacks || [];
      const container = document.getElementById('taggedItems');
      container.innerHTML = items.map(a => `<div class="tagged-item">${a.name}: ${a.damage} (${a.tag})</div>`).join('');
    }

    // Tag filter
    document.querySelectorAll('.tag-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tag = btn.dataset.tag;
        const items = document.querySelectorAll('.tagged-item');
        items.forEach(item => {
          item.style.display = (tag === 'all' || item.textContent.includes(tag)) ? 'block' : 'none';
        });
      };
    });

    function showPrintView() {
      const char = characters.find(c => c.id === currentId);
      if (!char) return;
      document.getElementById('printName').textContent = char.name;
      document.getElementById('printClassLevel').innerHTML = `<strong>${char.classLevel}</strong>`;
      document.getElementById('printRaceBg').innerHTML = `<strong>${char.raceBg}</strong>`;
      document.getElementById('printHpAc').innerHTML = `HP: ${char.hp} AC: ${char.ac}`;
      document.getElementById('printStr').innerHTML = `FOR ${char.strScore} (${mod(char.strScore)})`;
      // ... simili per altri stats [web:29]
      document.getElementById('printSkills').textContent = char.skills;
      document.getElementById('printFeatures').textContent = char.features;
      document.getElementById('printAttacksPrint').innerHTML = char.attacks.map(a => `${a.name} +${a.bonus} ${a.damage}`).join('<br>');
      document.getElementById('printView').style.display = 'block';
      document.querySelectorAll('.section:not(#printView)').forEach(s => s.style.display = 'none');
    }

    // Dirty flag
    document.querySelectorAll('input,textarea').forEach(el => {
      el.oninput = () => {
        if (!dirty) {
          dirty = true;
          el.classList.add('dirty');
        }
      };
    });

    // Search
    document.getElementById('searchInput').oninput = (e) => renderCharList(e.target.value);

    // Sync Drive [conversation_history:14]
    async function syncFromServer() {
      const badge = document.getElementById('syncBadge');
      try {
        badge.textContent = 'Sync: caricamento...';
        const res = await fetch(API_URL);
        const data = await res.json();
        if (data.ok && data.characters) {
          characters = data.characters;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(characters));
          renderCharList('');
          badge.textContent = 'Sync: OK (Drive)';
          badge.className = 'badge sync-ok';
        } else {
          throw new Error(data.error || 'No data');
        }
      } catch (err) {
        console.error(err);
        loadLocal();
        badge.textContent = 'Sync: locale only';
        badge.className = 'badge sync-err';
      }
    }

    async function syncToServer() {
      const badge = document.getElementById('syncBadge');
      try {
        badge.textContent = 'Sync: salvataggio...';
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ characters }),
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.ok) {
          badge.textContent = 'Sync: OK (Drive)';
          badge.className = 'badge sync-ok';
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        console.error(err);
        badge.textContent = 'Sync: errore salvataggio';
        badge.className = 'badge sync-err';
      }
    }

    function loadLocal() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) characters = JSON.parse(stored);
      renderCharList('');
    }

    function setDirty(state) { dirty = state; }

    // Init
    loadLocal();
    syncFromServer();
    newChar();
    addAttack(); // Uno di default
  </script>
</body>
</html>
